name: Django-app workflow

on: [push]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: üõí Checkout
        uses: actions/checkout@v2
      - name: üîé Check IP
        run: curl https://api.ipify.org
  tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 
      uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - name: Install dependencies
      run: | 
        # –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ pip
        python -m pip install --upgrade pip 
        # —É—Å—Ç–∞–Ω–æ–≤–∫–∞ flake8 –∏ –µ–≥–æ –ø–ª–∞–≥–∏–Ω–æ–≤
        pip install flake8 pep8-naming flake8-broken-line flake8-return flake8-isort
        # —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        pip install -r requirements.txt 

    - name: Test with flake8 and django tests
      run: |
        # –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ flake8
        python -m flake8
        # –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É, —Å–æ–¥–µ—Ä–∂–∞—â—É—é manage.py ‚Äî 
        #<–∫–æ—Ä–Ω–µ–≤–∞—è_–ø–∞–ø–∫–∞_infra_actions>/<–ø–∞–ø–∫–∞_–ø—Ä–æ–µ–∫—Ç–∞>/manage.py
        cd infra_project/
        # –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º —Ç–µ—Å—Ç—ã
        python manage.py test
# –°—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–∏—Ö –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É: –¥–µ–ø–ª–æ–π 
  build_and_push_to_docker_hub:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Check out the repo
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Docker Hub –¥–ª—è workflow
        uses: actions/checkout@v2 
      - name: Set up Docker Buildx
        # –í—ã–∑–æ–≤ —Å–±–æ—Ä—â–∏–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ docker
        uses: docker/setup-buildx-action@v1 
      - name: Login to Docker 
        # –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ Docker Hub 23232323
        uses: docker/login-action@v1 
        with:
          username: ${{ secrets.DOCKER_USERNAME }} 
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Push to Docker Hub
        # –ü—É—à –æ–±—Ä–∞–∑–∞ –≤ Docker Hub 
        uses: docker/build-push-action@v2 
        with:
          push: true
          tags: iriderpro/infra_actions:latest
  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push_to_docker_hub
    steps:
    - name: executing remote ssh commands to deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: ${{ secrets.SSH_KEY }}
        passphrase: ${{ secrets.PASSPHRASE }} # –ï—Å–ª–∏ –≤–∞—à ssh-–∫–ª—é—á —Ñ—Ä–∞–∑–æ–π-–ø–∞—Ä–æ–ª–µ–º 232323
        script: |
          # –í—ã–ø–æ–ª–Ω—è–µ—Ç pull –æ–±—Ä–∞–∑–∞ —Å DockerHub
          sudo docker pull iriderpro/infra_actions
          #–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          sudo docker stop $(sudo docker ps -a -q)
          sudo docker run --rm -d -p 5000:5000 iriderpro/infra_actions




